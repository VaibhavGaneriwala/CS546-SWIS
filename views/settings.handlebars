<div class="settings-container">
    <h1>Settings</h1>
    <div class="error-message" style="display: {{#if error}}block{{else}}none{{/if}}">{{error}}</div>
    
    <!-- Profile Picture Section -->
    <div class="profile-picture-section">
        <div class="current-profile-picture">
            {{#if user.profilePicture}}
                <img src="{{user.profilePicture}}" alt="Profile Picture" class="profile-picture">
            {{else}}
                <div class="default-profile-picture">
                    <span>{{firstLetter user.firstName}}{{firstLetter user.lastName}}</span>
                </div>
            {{/if}}
        </div>
        <form action="/settings/profile-picture" method="POST" enctype="multipart/form-data" class="profile-picture-form">
            <div class="form-group">
                <label for="profilePicture">Update Profile Picture</label>
                <input type="file" id="profilePicture" name="profilePicture" accept="image/*" required>
            </div>
            <button class="btn" type="submit">Upload Picture</button>
        </form>
    </div>

    <div class="settings-form">
        <form action="/settings" method="POST">
            <div class="form-group">
                <label for="firstName">First Name</label>
                <input type="text" id="firstName" name="firstName" value="{{capitalizeFirst user.firstName}}" required>
            </div>
            <div class="form-group">
                <label for="lastName">Last Name</label>
                <input type="text" id="lastName" name="lastName" value="{{capitalizeFirst user.lastName}}" required>
            </div>
            <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" name="email" value="{{user.email}}" required>
            </div>
            <div class="form-group">
                <label for="username">Username</label>
                <input type="text" id="username" name="username" value="{{user.username}}" required>
            </div>
            <button class="btn" type="submit">Save Changes</button>
        </form>
    </div>
</div>

<script>
    function showError(message){
        const errorDiv = document.querySelector('.error-message')
        if(errorDiv){
            errorDiv.textContent = message
            errorDiv.style.display = 'block'
            
            setTimeout(() => { errorDiv.style.display = 'none' }, 5000)
        }
    }

    function isValidEmail(email){
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/
        return emailRegex.test(email)
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        const errorMessage = document.querySelector('.error-message')
        if(errorMessage){
            errorMessage.style.display = 'none'
        }

        // Profile picture preview
        const profilePictureInput = document.getElementById('profilePicture')
        if(profilePictureInput) {
            profilePictureInput.addEventListener('change', function(e) {
                const file = e.target.files[0]
                if(file) {
                    if(file.size > 5 * 1024 * 1024) { // 5MB
                        showError('File size must be less than 5MB')
                        this.value = ''
                        return
                    }
                    
                    const allowedTypes = ['image/jpeg', 'image/png', 'image/gif']
                    if(!allowedTypes.includes(file.type)) {
                        showError('Only JPG, PNG and GIF files are allowed')
                        this.value = ''
                        return
                    }
                }
            })
        }

        const settingsForm = document.querySelector('form[action="/settings"]')
        if(settingsForm){
            settingsForm.addEventListener('submit', async (e) => {
                e.preventDefault()

                const firstName = document.getElementById('firstName').value.trim()
                const lastName = document.getElementById('lastName').value.trim()
                const email = document.getElementById('email').value.trim()
                const username = document.getElementById('username').value.trim().toLowerCase()

                if(!firstName || !lastName || !email || !username){
                    showError('Please fill in all fields')
                    return
                }

                if(!isValidEmail(email)){
                    showError('Please enter a valid email address')
                    return
                }

                settingsForm.submit()
            })
        }
    })
</script>